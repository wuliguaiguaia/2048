<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        body{
            margin: 0;
            background: #333;
            color: #fff;
            padding: 10px;
        }
        #swiper{
            width: 100%;
            overflow: hidden;
        }
        #board{
            position: relative;
            background-color: #ccc;
            border-radius: 6px;
            width: 100%;
            overflow: hidden;
        }
        #board > div{
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            transition: all ease 1s;
        }
        .new-cell{
            animation: scale 1s ease ;
        }
        .number-cell{
            width: 20%;
            background-color: #c59e67;
            height: 20%;
            float: left;
            margin-left: 4%;
            margin-top: 4%;
            border-radius: 6px;
        }

        @keyframes scale {
            0%{
                transform: scale(0)
            }

            100%{
                transform: scale(1);
            }
        }
        
       
    
    </style>
</head>
<body>
    <!--
        游戏逻辑：全程对 boardArr(4*4二维数组保存每个格子的值2/4/8) 静态#board只做面板，再向#board添加16个格子 newCell，根据num设置样式， 每次移动重置 boardArr
         一. 静态布局 number 
         二. 动态设置宽高，适应不同设备，绝对定位每个格子
         三. 初始化 boardArr，
         四. 产生两个 随机位置，随机数字 2/4，
         五. 根据每个格子的值 对其样式控制
         六. 
    -->
    <div id="swiper">
        <div id="newGame">start again!</div>
        <div id="score">0</div>
        <div id="board">
            <div class="number-cell" id="number-cell-0-0">1</div>
            <div class="number-cell" id="number-cell-0-1"></div>
            <div class="number-cell" id="number-cell-0-2"></div>
            <div class="number-cell" id="number-cell-0-3"></div>
            <div class="number-cell" id="number-cell-1-0"></div>
            <div class="number-cell" id="number-cell-1-1"></div>
            <div class="number-cell" id="number-cell-1-2"></div>
            <div class="number-cell" id="number-cell-1-3"></div>
            <div class="number-cell" id="number-cell-2-0"></div>
            <div class="number-cell" id="number-cell-2-1"></div>
            <div class="number-cell" id="number-cell-2-2"></div>
            <div class="number-cell" id="number-cell-2-3"></div>
            <div class="number-cell" id="number-cell-3-0"></div>
            <div class="number-cell" id="number-cell-3-1"></div>
            <div class="number-cell" id="number-cell-3-2"></div>
            <div class="number-cell" id="number-cell-3-3"></div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded",()=>{
            new newGame("#board",".number-cell");
        })
        class newGame{
            constructor(parent,child){
                this.board = document.querySelector(parent);
                this.numberCell = this.board.querySelectorAll(child);
                this.W = this.board.offsetWidth;
                this.gap = this.numberCell[0].offsetLeft;
                this.w = this.numberCell[0].offsetWidth;
                this.boardArr = [];
                this.init();
            }
            init(){
                this.removeNewCell();
                this.board.style.height = `${this.W}px`;

                for(let i = 0;i<4;i++ ){
                    this.boardArr[i] = [];
                    for(let j = 0 ; j < 4 ;j++){
                        this.boardArr[i][j] = 0;
                    }
                }

                this.generateOneNumber();
                this.generateOneNumber();

                this.appendNewCell();

                this.updateCell();
                this.register();

            }
            generateOneNumber(){
                let [num,i,j] = [,0,0];
                while(this.boardArr[i][j] == 0){
                    num = Math.random() > 0.5 ? 2 : 4;
                    i = ~~(Math.random()*4);
                    j = ~~(Math.random()*4);
                    this.boardArr[i][j] = num;
                }
            }
            appendNewCell(){
                for(let i = 0;i<4;i++ ){
                    for(let j = 0 ; j < 4 ;j++){
                        let element = document.createElement('div');
                        element.classList.add('new-cell');
                        element.id= `new-cell-${i}-${j}`;
                        this.board.appendChild(element);
                    }
                }
            }
            removeNewCell(){
                let element = document.getElementsByClassName("new-cell");
                [...element].forEach((item,i,arr)=>{
                    this.board.removeChild(item);
                })
            }
            updateCell(){
                for(let i = 0;i<4;i++ ){
                    for(let j = 0 ; j < 4 ;j++){
                        let element = document.querySelector(`#new-cell-${i}-${j}`);
                        let num = this.boardArr[i][j]
                        if( num == 0){
                            element.innerHTML = '';
                        }else{
                            element.innerHTML = num;
                            element.style.cssText = `
                            width:${this.w}px;
                            height:${this.w}px;
                            position:absolute;left:${this.getPosition(i,j).left}px;
                            top:${this.getPosition(i,j).top}px;background-color:${this.getBackgroundColor(num)};
                            color:${this.getColor(num)}`
                        }
                    }
                }
            }
            register(){
                document.addEventListener("keydown",(e)=>{
                    let key = e.key;
                    switch(key){
                        case "ArrowRight":{
                            this.moveRight();
                            this.generateOneNumber();
                            
                        }
                    }
                })
            }
            canMoveRight(){
                for(let i = 0 ; i < 4 ; i++){
                    for(let j = 0 ; j < 4 ; j++){
                        if(this.nospace() && this.boardArr[i][j-1] != this.boardArr[i][j]){
                            return false;
                        }
                        else{
                            return true;
                        }
                    }
                }
            }
            moveRight(){
                if(this.canMoveRight()){
                    for(let j = 2 ; j>=0; j--){
                        for(let i = 0 ; i < 4; i++){
                            if(this.boardArr[i][j] != 0){
                                if(this.boardArr[i][j+1] == 0 || this.boardArr[i][j+1] == this.boardArr[i][j]){
                                    this.showAnimation("horizontal",i,j,);
                                    this.boardArr[i][j+1] = this.boardArr[i][j];
                                    this.boardArr[i][j] = 0;
                                }
                            }
                        }
                    }
                }
            }
            showAnimation(dir){
                for(let i = 0 ; i < 4 ; i++){
                    for(let j = 0 ; j < 4 ; j++){
                        if(this.boardArr[i][j] != 0){
                           let element = document.querySelector(`#new-cell-${i}-${j}`);
                           let left = parseInt(getComputedStyle(element,false).left);
                           let top = parseInt(getComputedStyle(element,false).top);

                            switch(dir){
                                case 'horizontal':
                                    if(this.boardArr[i][j])
                                    break;
                                case 'horizontal-l':
                                
                                    break;
                            }
                        }
                    }
                }
            }
            nospace(){
                for(let i = 0 ; i < 4 ; i++){
                    for(let j = 0 ; j < 4 ; j++){
                        if(this.boardArr[i][j] != 0){
                            return true;
                        }
                        else{
                            return false;
                        }
                    }
                }
            }
            
            getPosition(i,j){
                return{
                    top:(i+1)*this.gap + i*this.w,
                    left:(j+1)*this.gap + j*this.w
                }
            }
            getBackgroundColor(num){
                switch(num){
                    case 2:
                        return "red";
                        break;  
                    case 4:
                        return "yellow";
                        break;  
                }
            }
            getColor(num){
                switch(num){
                    case 2 || 4:
                        return "blue";
                        break;  
                }
            }
        }
       
    </script>
</body>
</html>